name: .NET Core Test

on: pull_request

env:
  DOTNET_VERSION: 10.0.x

jobs:
  Test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - name: Checkout
      uses: actions/checkout@v5
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    - name: Check format
      if: runner.os == 'Linux'
      run: dotnet format --no-restore --verify-no-changes --verbosity diagnostic
    - name: Build CLI
      if: runner.os == 'Linux'
      run: |
        dotnet publish -o ./out -c Release src/Neo.CLI
        find ./out -name 'config.json' | xargs perl -pi -e 's|LevelDBStore|MemoryStore|g'
    - name: Install dependencies
      if: runner.os == 'Linux'
      run: sudo apt-get install libleveldb-dev expect
    - name: Run tests with expect
      if: runner.os == 'Linux'
      run: expect ./.github/workflows/test-neo-cli.expect
    - name: Run Unit Tests
      if: runner.os == 'Windows'
      run: |
        forfiles /p tests /m *.csproj /s /c "cmd /c dotnet add @PATH package coverlet.msbuild"
        dotnet test /p:CollectCoverage=true /p:CoverletOutput='${{ github.workspace }}/TestResults/coverage/' /p:MergeWith='${{ github.workspace }}/TestResults/coverage/coverage.json' /p:CoverletOutputFormat=lcov%2cjson -m:1
    - name: Coveralls
      if: runner.os == 'Windows'
      uses: coverallsapp/github-action@v2
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        format: lcov
        file: ${{ github.workspace }}/TestResults/coverage/coverage.info

  Test-with-plugins:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - name: Checkout
      uses: actions/checkout@v5
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    - name: Check format
      if: runner.os == 'Linux'
      run: dotnet format --no-restore --verify-no-changes --verbosity diagnostic
    - name: Build CLI
      if: runner.os == 'Linux'
      run: |
        dotnet build -c Release
        dotnet publish -o ./out -c Release src/Neo.CLI
    - name: Create Plugins folder and copy plugin DLLs
      if: runner.os == 'Linux'
      run: |
        mkdir -p ./out/Plugins
        for plugin_dir in plugins/*/; do
          plugin_name=$(basename "$plugin_dir")
          build_output="$plugin_dir/bin/Release/net10.0"
          if [ -d "$build_output" ]; then
            mkdir -p "./out/Plugins/$plugin_name"
            cp -r "$build_output"/* "./out/Plugins/$plugin_name/"
          else
            echo "Warning: Build output not found for $plugin_name"
          fi
        done
    - name: Install dependencies
      if: runner.os == 'Linux'
      run: sudo apt-get install libleveldb-dev expect
    - name: Debug - List Plugins folder contents
      if: runner.os == 'Linux'
      run: |
        echo "Plugins folder contents:"
        ls -la ./out/Plugins/ || echo "Plugins folder does not exist"
        echo ""
        echo "Plugin directories:"
        find ./out/Plugins -mindepth 1 -maxdepth 1 -type d | sort || echo "No plugin directories found"
        echo ""
        echo "Sample plugin DLLs (ApplicationLogs):"
        ls -la ./out/Plugins/ApplicationLogs/*.dll 2>/dev/null | head -5 || echo "No DLLs found"
    - name: Run tests with expect
      if: runner.os == 'Linux'
      run: expect ./.github/workflows/test-neo-cli-plugins.expect
